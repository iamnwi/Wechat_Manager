<!DOCTYPE HTML>
<html>

<head>

  <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="http://cdn.rawgit.com/jeromeetienne/jquery-qrcode/master/jquery.qrcode.min.js"></script>
  <script type="text/javascript">
    function addElement(id, obj) {　　　　
      var parent = document.getElementById(id);　　　　
      parent.appendChild(obj);　　
    }

    function ws_login() {
      // var wsUri = "ws://localhost:8000/ws/login"
      var wsUri = 'ws://' + window.location.host + '/wslogin'
      websocket = new WebSocket(wsUri);
      websocket.onopen = function(evt) {
        console.log(evt);
      };
      websocket.onclose = function(evt) {
        console.log(evt);
      };
      websocket.onmessage = function(evt) {
        console.log("/on message");
        console.log(evt);
        console.log("on message/");
        data = JSON.parse(evt.data);
        if (data['type'] == "uuid") {
          console.log("uuid = " + data['uuid'])
          var text = "https://login.weixin.qq.com/l/" + data['uuid'];
          jQuery(function() {
              $('#qrcode_div').qrcode({
                width: 256,
                height: 256,
                text: text
              });
          });
          var canvas = $('#qrcode_div canvas');
          console.log(canvas);
          var img = canvas.get(0).toDataURL("image/png");
          document.write('<img src="' + img + '"/>');
        }
      };
      websocket.onerror = function(evt) {
        console.log("Error!");
      };
    }

    $(document).ready(function() {
      $("#btn_login").click(function() {
        ws_login()
      });
    });
  </script>

</head>

<body>

  <div id="qrcode_div">
    <img id="qrcode_img"></img>
  </div>
  <div id="button_div">
    <button id="btn_login">Login Web Wechat</button>
  </div>

</body>

</html>
